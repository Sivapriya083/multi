# =============================================================================
# ros2_controllers.yaml — Custom Dual-Arm Impedance Controller Configuration
# Replaces: joint_trajectory_controller (off-the-shelf)
# Uses:     dual_arm_controller/DualArmImpedanceController (custom plugin)
# =============================================================================

controller_manager:
  ros__parameters:
    update_rate: 100  # Hz — matches hardware interface publish rate

    # --- System-level broadcaster (always required) ---
    joint_state_broadcaster:
      type: joint_state_broadcaster/JointStateBroadcaster

    # --- Custom Impedance + Coordination Controller ---
    # Replaces left_arm_controller + right_arm_controller from JTC approach
    # Both arms managed in one plugin for tight real-time coupling
    dual_arm_impedance_controller:
      type: dual_arm_controller/DualArmImpedanceController


# =============================================================================
# Custom Controller Parameters
# These are read by DualArmImpedanceController::on_configure()
# =============================================================================

dual_arm_impedance_controller:
  ros__parameters:

    # --- Left Arm Joints ---
    left_joints:
      - left_shoulder_pan_joint
      - left_shoulder_lift_joint
      - left_elbow_joint
      - left_wrist_1_joint
      - left_wrist_2_joint
      - left_wrist_3_joint

    # --- Right Arm Joints ---
    right_joints:
      - right_shoulder_pan_joint
      - right_shoulder_lift_joint
      - right_elbow_joint
      - right_wrist_1_joint
      - right_wrist_2_joint
      - right_wrist_3_joint

    # --- Impedance Gains (PD per arm) ---
    # Kp: stiffness — how hard the arm tracks the target position
    # Kd: damping  — how much velocity error is resisted (prevents oscillation)
    # These are diagonal gain values (one per joint, applied as diagonal matrix)
    # TUNING: Increase Kp for tighter tracking, increase Kd to reduce overshoot
    kp_left:  [200.0, 200.0, 200.0, 100.0, 100.0, 100.0]
    kd_left:  [ 20.0,  20.0,  20.0,  10.0,  10.0,  10.0]
    kp_right: [200.0, 200.0, 200.0, 100.0, 100.0, 100.0]
    kd_right: [ 20.0,  20.0,  20.0,  10.0,  10.0,  10.0]

    # --- Coordination Coupling Gain ---
    # k_coord: spring constant enforcing (q_left - q_right == coord_offset)
    # Higher = tighter coupling between arms (but can cause oscillation if too high)
    # TUNING: Start at 30.0, raise to 80.0 if coordination errors are large
    k_coord: 50.0

    # --- Desired Coordination Offset (q_left - q_right) per joint ---
    # For symmetric grasp: both arms mirror each other on pan axis (offset = 0)
    # For object handoff: modify offset to reflect geometry of the task
    coord_offset: [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

    # --- Control output mode ---
    # "position_delta": cmd = q_current + gain_output * dt  (safe, smooth)
    # "position_direct": cmd = q_desired  (faster but less compliant)
    control_mode: "position_delta"

    # --- Safety limits ---
    max_position_delta: 0.05   # rad per control cycle — prevents large jumps
    joint_position_limits:
      min: [-6.28, -6.28, -3.14, -6.28, -6.28, -6.28]
      max: [ 6.28,  6.28,  3.14,  6.28,  6.28,  6.28]

    # --- Data publishing ---
    publish_rate: 50.0   # Hz — rate to publish controller diagnostics for logging


# =============================================================================
# Joint State Broadcaster Parameters
# =============================================================================

joint_state_broadcaster:
  ros__parameters:
    joints:
      - left_shoulder_pan_joint
      - left_shoulder_lift_joint
      - left_elbow_joint
      - left_wrist_1_joint
      - left_wrist_2_joint
      - left_wrist_3_joint
      - right_shoulder_pan_joint
      - right_shoulder_lift_joint
      - right_elbow_joint
      - right_wrist_1_joint
      - right_wrist_2_joint
      - right_wrist_3_joint
    extra_joints: []
    map_interface_to_joint_state:
      position: position
      velocity: velocity
      effort: effort